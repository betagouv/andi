language: node_js
node_js:
- '10.0'

git:
  submodules: false
dist: trusty
sudo: false
notifications:
  slack: andi-startup:4EvkZ1UZEV4LwZXzvXhDGP8u


# TODO: add S3 integration to copy stage artefacts
jobs:
  include:
  - stage: Build
    name: Build static pages
    script: npm run build
    skip_cleanup: true
  - stage: Deploy
    name: Deploy pages to host
    if: branch = master AND type = push AND fork = false
    skip_cleanup: true
    script: 
      - npm run build
      - rsync -e "ssh -i deploy_ed25519" -r --delete-after --quiet public/ travis@andi.beta.gouv.fr:/var/www/static_ci/

addons:
  ssh_known_hosts: andi.beta.gouv.fr

before_install:
  - openssl aes-256-cbc -K $encrypted_218785b12a81_key -iv $encrypted_218785b12a81_iv -in deploy_ed25519.enc -out deploy_ed25519 -d
  - chmod 600 deploy_ed25519
