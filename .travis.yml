language: node_js
node_js:
- '10.0'

git:
  submodules: false
dist: trusty
sudo: false
cache:
  directories:
    - public
notifications:
  slack: andi-startup:4EvkZ1UZEV4LwZXzvXhDGP8u

# TODO: add S3 integration to copy stage artefacts
jobs:
  include:
  - stage: Build
    name: Build static pages
    script: 
      - npm run build
    skip_cleanup: true
  - name: Build docker evolutility
    script:
      - echo "Building commit $TRAVIS_COMMIT"
      - cd misc/docker/evolutility
      - echo "$DOCKER_PW" | docker login -u "$DOCKER_USER" --password-stdin
      - >
        docker build -t andi_evolutility
        --build-arg PG_USER=$PG_USER 
        --build-arg PG_PASS=$PG_PASS
        --build-arg PG_PORT=$PG_PORT ./
      - docker images
      - docker tag andi_evolutility $DOCKER_USER/private:evolutility
      - docker push $DOCKER_USER/private:evolutility
  - name: Build docker form_handler
    script:
      - cd misc/docker/form_handler
      - echo "$DOCKER_PW" | docker login -u "$DOCKER_USER" --password-stdin
      - >
        docker build -t andi_formhandler
        --build-arg PG_USER=$PG_USER 
        --build-arg PG_PASS=$PG_PASS
        --build-arg PG_PORT=$PG_PORT ./
      - docker images
      - docker tag andi_formhandler $DOCKER_USER/private:andi_formhandler
      - docker push $DOCKER_USER/private:andi_formhandler
  - name: Deploy docker evolutility
    script:
      - ssh -i deploy_ed25519 \'echo "$DOCKER_PW" | docker login -u "$DOCKER_USER" --password-stdin\'
      - ssh -i deploy_ed25519 \\'docker stop evolutility || true\\'
      - ssh -i deploy_ed25519 \\\'docker pull\\\'
      - ssh -i deploy_ed25519 ''docker run -d --rm -p 8080:3000 --add-host=database:172.17.0.1 --ip 172.17.0.2 --name evolutility''

  - stage: Deploy
    name: Deploy pages to host
    if: branch = master AND type = push AND fork = false
    skip_cleanup: true
    script: 
      - ls public/
      - npm run build
      - rsync -e "ssh -i deploy_ed25519" -r --delete-after --quiet public/ travis@andi.beta.gouv.fr:/var/www/static_ci/
      - >
        curl
        --header "Content-Type: application/json"
        --request POST --data "{\"message\":\"ANDi - Site mis a jour\"}"
        https://hooks.zapier.com/hooks/catch/5355796/oo5ibqz/
addons:
  ssh_known_hosts: andi.beta.gouv.fr

before_install:
  - openssl aes-256-cbc -K $encrypted_218785b12a81_key -iv $encrypted_218785b12a81_iv -in misc/deploy_ed25519.enc -out deploy_ed25519 -d
  - chmod 600 deploy_ed25519
